const { createApp } = Vue;
createApp({
  data() {
    // API KEY
    let key = "";
    // 初次載入頁面的時間，
    let loadingHour = new Date().getHours();
    return {
      locationsZh: [
        "基隆市",
        "臺北市",
        "新北市",
        "宜蘭縣",
        "桃園市",
        "新竹市",
        "新竹縣",
        "苗栗縣",
        "臺中市",
        "彰化縣",
        "南投縣",
        "雲林縣",
        "嘉義市",
        "嘉義縣",
        "臺南市",
        "高雄市",
        "屏東縣",
        "花蓮縣",
        "臺東縣",
        "澎湖縣",
        "金門縣",
        "連江縣"
      ],
      locationsEn: [
        "KLU",
        "TPE",
        "TPH",
        "ILN",
        "TYC",
        "HSC",
        "HSH",
        "MAL",
        "TXG",
        "CWH",
        "NTO",
        "YLH",
        "CYI",
        "CHY",
        "TNN",
        "KHH",
        "IUH",
        "HWA",
        "TTT",
        "PEH",
        "KMN",
        "MZW"
      ],
      selectedLocation: "",
      CWA: null,
      currentLocation: null,
      // 初始為null，在:class綁定仍會被判定為false而變成夜間背景。如果早上使用此工具，仍會在載入頁面時有非常迅速的背景切換。
      // light: null,
      light: loadingHour >= 6 && loadingHour < 18 ? true : false,
      isActive: false
    };
  },
  watch: {
    selectedLocation(newValue, oldValue) {
      this.selectedLocation = newValue;
      // 不想用 button @click 來監聽事件，所以每當改變 select 選擇，就調用函式
      this.correspondData();
      this.isActive = true;
    }
  },
  methods: {
    correspondData() {
      for (let indexEn in this.locationsEn) {
        if (this.locationsEn[indexEn] === this.selectedLocation) {
          for (let indexCWA in this.CWA) {
            if (this.CWA[indexCWA].locationName === this.locationsZh[indexEn]) {
              this.currentLocation = this.CWA[indexCWA];

              // console.log(this.CWA[indexCWA].weatherElement[0].time[0].parameter.parameterName)
              // console.log(this.currentLocation.weatherElement[0].time[0].parameter.parameterName)
              // console.log(this.currentLocation)
            }
          }
        }
      }
    },
    updateBackground() {
      let date = new Date();
      let hour = date.getHours();

      console.log(date);
      console.log("現在「時」為 " + hour + " 點鐘");

      // 18:00就要切換成夜間模式。
      this.light = hour >= 6 && hour < 18 ? true : false;
      console.log(
        this.light === true
          ? "this.light 應為 日間模式"
          : "this.light 應為 夜間模式"
      );
    }
  },
  mounted() {
    this.key = prompt("請輸入金鑰 (API KEY)");
    fetch(
      "https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-C0032-001?Authorization=" +
        this.key +
        "&format=JSON",
      { method: "GET" }
    )
      .then((res) => {
        alert("Password correct!");
        console.log(res.ok);
        if (!res.ok) {
          console.log(res.status);
        }
        return res.json();
      })
      .then((json) => {
        this.CWA = json.records.location;
        // console.log(this.CWA);

        // 檢查data()的light結果
        console.log("data()的light結果: " + this.light);

        // 日夜立即切換檢查改這裡，並把setInterval註解掉
        // this.light = true;

        // 之後每秒檢查一次現在時間，用以切換日夜背景
        setInterval(this.updateBackground, 1000);
      })
      .catch((error) => {
        alert(
          "請稍後再試。若您是在公開網頁（如：CodePen、GitHub）瀏覽，為確保API KEY隱私性，而不提供正確的fetch API KEY"
        );
        console.log(error);
      });
  }
}).mount("#wrap");
